<!DOCTYPE html>
<html>
<head>
    <title>Test Email Direct</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
    </style>
</head>
<body>
    <h1>Test Email Notification - Direct Call</h1>
    <p>Questo script chiama direttamente l'Edge Function per testare l'invio email.</p>

    <button onclick="testEmail()">Invia Email di Test</button>

    <div id="output" class="log"></div>

    <script>
        const SUPABASE_URL = 'https://uphftgpwisdiubuhohnc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwaGZ0Z3B3aXNkaXVidWhvaG5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA5MjYyMzQsImV4cCI6MjA0NjUwMjIzNH0.Nt3n1axV5TaDPSXrzaO0PLd78pJ-T2CdhTIKJdmhEPY';

        function log(message, isError = false) {
            const output = document.getElementById('output');
            const timestamp = new Date().toISOString();
            const className = isError ? 'error' : '';
            output.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        async function testEmail() {
            const output = document.getElementById('output');
            output.innerHTML = '';

            log('=== Starting Test ===');

            // First, get the session token (you need to be logged in)
            const accessToken = prompt('Inserisci il tuo access token (da DevTools > Application > Local Storage > sb-uphftgpwisdiubuhohnc-auth-token):');

            if (!accessToken) {
                log('Test annullato: token non fornito', true);
                return;
            }

            log('Token ricevuto: ' + accessToken.substring(0, 20) + '...');
            log('Chiamata a: ' + SUPABASE_URL + '/functions/v1/test-notification-email');

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/test-notification-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`,
                        'apikey': SUPABASE_ANON_KEY,
                    },
                });

                log('Response status: ' + response.status);
                log('Response headers: ' + JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2));

                const data = await response.json();
                log('Response body: ' + JSON.stringify(data, null, 2));

                if (response.ok && data.success) {
                    log('✅ SUCCESS: ' + data.message, false);
                } else {
                    log('❌ ERROR: ' + (data.error || 'Unknown error'), true);
                }
            } catch (error) {
                log('❌ EXCEPTION: ' + error.message, true);
                log('Stack: ' + error.stack, true);
            }

            log('=== Test Completed ===');
        }
    </script>
</body>
</html>
